{% extends "base.html" %}
{% block title %}Отчеты — Продажи{% endblock %}
{% block content %}
<section class="panel">
  <div class="panel-header">
    <h2>Отчеты</h2>
    <form method="get" class="inline">
      <a class="btn secondary small" href="{{ url_for('admin_reports_export_csv', **{'from': date_from, 'to': date_to} ) }}">Экспорт CSV</a>
      <input type="date" name="from" value="{{ date_from }}">
      <input type="date" name="to" value="{{ date_to }}">
      <button type="submit" class="btn small">Показать</button>
    </form>
  </div>

  <div class="stats">
    <div class="stat">
      <div class="stat-title">Выручка</div>
      <div class="stat-value">{{ "%.2f"|format(revenue) }}</div>
    </div>
    <div class="stat">
      <div class="stat-title">Прибыль</div>
      <div class="stat-value">{{ "%.2f"|format(profit) }}</div>
    </div>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>Дата/время</th>
        <th>Товар</th>
        <th>Кол-во</th>
        <th>Цена до скидки</th>
        <th>Скидка</th>
        <th>Итоговая цена</th>
        <th>Сумма</th>
        <th>Прибыль</th>
        <th>Кассир</th>
      </tr>
    </thead>
    <tbody>
      {% if sales and sales|length > 0 %}
        {% for s in sales %}
        <tr>
          <td>{{ s.created_at|msk('%Y-%m-%d %H:%M') }}</td>
          <td>{% if s.product %}{{ s.product.name }}{% else %}[удален] (#{{ s.product_id }}){% endif %}</td>
          <td class="num">{{ s.quantity }}</td>
          <td class="num">{{ "%.2f"|format(s.unit_price_sold) }}</td>
          <td>
            {% if s.discount_type == 'percent' %}{{ s.discount_value }}%
            {% elif s.discount_type == 'fixed' %}{{ "%.2f"|format(s.discount_value) }}
            {% else %}-{% endif %}
          </td>
          <td class="num">{{ "%.2f"|format(s.final_unit_price) }}</td>
          <td class="num">{{ "%.2f"|format(s.total_price) }}</td>
          <td class="num">{{ "%.2f"|format(s.profit) }}</td>
          <td>{{ s.cashier or "-" }}</td>
        </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="9" class="muted">Нет продаж за период.</td></tr>
      {% endif %}
    </tbody>
  </table>
</section>
{% endblock %}


  <h3>Список продаж</h3>
  <div class="table-scroll">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Дата/время</th>
          <th>Товар</th>
          <th>SKU</th>
          <th class="num">Кол-во</th>
          <th class="num">Сумма</th>
          <th>Кассир</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        {% for s in sales[:200] %}
        <tr>
          <td>{{ s.id }}</td>
          <td>{{ s.created_at|msk('%Y-%m-%d %H:%M') }}</td>
          <td>{{ s.product.name if s.product else '[удален] #' ~ s.product_id }}</td>
          <td>{{ s.product.sku if s.product else '-' }}</td>
          <td class="num">{{ s.quantity }}</td>
          <td class="num">{{ '%.2f'|format(s.total_price or 0) }}</td>
          <td>{{ s.cashier or '-' }}</td>
          <td>
            <form method="post" action="{{ url_for('admin_sales_delete', sid=s.id) }}"
                  onsubmit="return confirm('Удалить продажу #{{ s.id }}? Товар будет возвращен на склад.')">
              {{ csrf_field() }}
              <button type="submit" class="btn small" style="background:#b91c1c;border-color:#7f1d1d">Удалить</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="8" class="muted">Нет продаж за выбранный период</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
